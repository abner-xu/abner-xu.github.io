<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="referrer" content="same-origin">
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="XuChen的博客">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://xuchen.youtuc.cn">
    <!--SEO-->

    <meta name="keywords" content="JAVA类库技巧">


    <meta name="description" content="1. 规范背景1.1. http client选择
如无特殊情况（比如：单机tps上千），建议选Spring Rest Template做门面，Apache HttpClient 4.x做实现
...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>HttpClient使用技巧 | XuChen的博客</title>


    <link rel="alternate" href="/atom.xml" title="XuChen的博客" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    



    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?312e8b385d973dd9c15c283aa84ea6a8";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>



    

    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  style="background-image:url(http://ww2.sinaimg.cn/large/0078bOVFgy1g0xp1zlruqj30zk05a0un.jpg);background-repeat:round;"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='abner'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> 待到风起时，扬帆济沧海 </h2>
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://xuchen.youtuc.cn">XuChen的博客</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/后端/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/前端/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/工具/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives/"><i class="fa "></i>归档</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container-fluid">
            <div class="row">
                <main class="col-xs-12 col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="HttpClient使用技巧">
            
	            HttpClient使用技巧
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/后端/">后端</a> <a class="category-link" href="/categories/后端/JAVA/">JAVA</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/JAVA类库技巧/">JAVA类库技巧</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2018/07/26</span>
        </span>
        
            <span class="fa-wrap">
                <i class="fa fa-eye"></i>
                <span id="busuanzi_value_page_pv"></span>
            </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>1030</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <h2 id="1-规范背景"><a href="#1-规范背景" class="headerlink" title="1. 规范背景"></a>1. 规范背景</h2><h3 id="1-1-http-client选择"><a href="#1-1-http-client选择" class="headerlink" title="1.1. http client选择"></a>1.1. http client选择</h3><ul>
<li>如无特殊情况（比如：单机tps上千），建议选Spring Rest Template做门面，Apache HttpClient 4.x做实现</li>
</ul>
<h3 id="1-2-rest-template-运行环境"><a href="#1-2-rest-template-运行环境" class="headerlink" title="1.2. rest template 运行环境"></a>1.2. rest template 运行环境</h3><ul>
<li><p>jdk 1.8</p>
</li>
<li><p>spring boot项目</p>
</li>
</ul>
<h2 id="2-配置-rest-template"><a href="#2-配置-rest-template" class="headerlink" title="2. 配置 rest template"></a>2. 配置 rest template</h2><h3 id="2-1-引入jar包"><a href="#2-1-引入jar包" class="headerlink" title="2.1. 引入jar包"></a>2.1. 引入jar包</h3><ul>
<li><p>Spring Rest Template在spring-web模块中内置了，spring boot会自动帮你引进来，因此无需再引入</p>
</li>
<li><p>引入Apache HttpClient 4.x包:</p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 如果不配异步（AsyncRestTemplate），则不需要这个依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.5.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-编写-yml-文件配置（可选）"><a href="#2-2-编写-yml-文件配置（可选）" class="headerlink" title="2.2. 编写 yml 文件配置（可选）"></a>2.2. 编写 yml 文件配置（可选）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yml配置的优先级高于java配置；如果yml配置和java配置同时存在，则yml配置会覆盖java配置</span></span><br><span class="line"><span class="comment">####restTemplate的yml配置开始####</span></span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  restTemplate:</span><br><span class="line">    maxTotalConnect: 1000 <span class="comment">#连接池的最大连接数，0代表不限；如果取0，需要考虑连接泄露导致系统崩溃的后果</span></span><br><span class="line">    maxConnectPerRoute: 200</span><br><span class="line">    connectTimeout: 3000</span><br><span class="line">    readTimeout: 5000</span><br><span class="line">    charset: UTF-8</span><br><span class="line"><span class="comment">####restTemplate的 yml配置开始####</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-编写java配置（必备，不可省略）"><a href="#2-3-编写java配置（必备，不可省略）" class="headerlink" title="2.3. 编写java配置（必备，不可省略）"></a>2.3. 编写java配置（必备，不可省略）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//xxx代表你的项目，例如：</span></span><br><span class="line"><span class="comment">//com.douyu.wsd.adx.gateway.config</span></span><br><span class="line"><span class="comment">//com.douyu.wsd.venus.config</span></span><br><span class="line"><span class="comment">//可以写一级，也可以写多级，具体自己随意</span></span><br><span class="line"><span class="keyword">package</span> com.douyu.wsd.xxx.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.Header;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.HttpRequestRetryHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.DefaultHttpRequestRetryHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.HttpClients;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.conn.PoolingHttpClientConnectionManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.message.BasicHeader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.ClientHttpRequestFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.HttpComponentsClientHttpRequestFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.Netty4ClientHttpRequestFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.HttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.converter.StringHttpMessageConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.AsyncRestTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.DefaultResponseErrorHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.restTemplate"</span>)</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(value = &#123;RestTemplate<span class="class">.<span class="keyword">class</span>, <span class="title">CloseableHttpClient</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">RestTemplateConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// java配置的优先级低于yml配置；如果yml配置不存在，会采用java配置</span></span><br><span class="line">    <span class="comment">// ####restTemplate的 java配置开始####</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxTotalConnection = <span class="number">500</span>; <span class="comment">//连接池的最大连接数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxConnectionPerRoute = <span class="number">100</span>; <span class="comment">//同路由的并发数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> connectionTimeout = <span class="number">2</span> * <span class="number">1000</span>; <span class="comment">//连接超时，默认2s</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> readTimeout = <span class="number">30</span> * <span class="number">1000</span>; <span class="comment">//读取超时，默认30s</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String charset = <span class="string">"UTF-8"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ####restTemplate的 java配置结束####</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaxTotalConnection</span><span class="params">(<span class="keyword">int</span> maxTotalConnection)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.maxTotalConnection = maxTotalConnection;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaxConnectionPerRoute</span><span class="params">(<span class="keyword">int</span> maxConnectionPerRoute)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.maxConnectionPerRoute = maxConnectionPerRoute;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConnectionTimeout</span><span class="params">(<span class="keyword">int</span> connectionTimeout)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.connectionTimeout = connectionTimeout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReadTimeout</span><span class="params">(<span class="keyword">int</span> readTimeout)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.readTimeout = readTimeout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCharset</span><span class="params">(String charset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.charset = charset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建HTTP客户端工厂</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"clientHttpRequestFactory"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientHttpRequestFactory <span class="title">clientHttpRequestFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createClientHttpRequestFactory(<span class="keyword">this</span>.connectionTimeout, <span class="keyword">this</span>.readTimeout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化RestTemplate,并加入spring的Bean工厂，由spring统一管理</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"restTemplate"</span>)</span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(RestTemplate<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">RestTemplate</span> <span class="title">restTemplate</span>(<span class="title">ClientHttpRequestFactory</span> <span class="title">factory</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createRestTemplate(factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化支持异步的RestTemplate,并加入spring的Bean工厂，由spring统一管理</span></span><br><span class="line">    <span class="comment">//如果你用不到异步，则无须创建该对象</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"asyncRestTemplate"</span>)</span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(AsyncRestTemplate<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">AsyncRestTemplate</span> <span class="title">asyncRestTemplate</span>(<span class="title">RestTemplate</span> <span class="title">restTemplate</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Netty4ClientHttpRequestFactory factory = <span class="keyword">new</span> Netty4ClientHttpRequestFactory();</span><br><span class="line">        factory.setConnectTimeout(<span class="keyword">this</span>.connectionTimeout);</span><br><span class="line">        factory.setReadTimeout(<span class="keyword">this</span>.readTimeout);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncRestTemplate(factory, restTemplate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ClientHttpRequestFactory <span class="title">createClientHttpRequestFactory</span><span class="params">(<span class="keyword">int</span> connectionTimeout, <span class="keyword">int</span> readTimeout)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//maxTotalConnection 和 maxConnectionPerRoute 必须要配</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.maxTotalConnection &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"invalid maxTotalConnection: "</span> + maxTotalConnection);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.maxConnectionPerRoute &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"invalid maxConnectionPerRoute: "</span> + maxTotalConnection);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//全局默认的header头配置</span></span><br><span class="line">        List&lt;Header&gt; headers = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        headers.add(<span class="keyword">new</span> BasicHeader(<span class="string">"Accept-Encoding"</span>, <span class="string">"gzip,deflate"</span>));</span><br><span class="line">        headers.add(<span class="keyword">new</span> BasicHeader(<span class="string">"Accept-Language"</span>, <span class="string">"zh-CN,zh;q=0.8,en;q=0.6"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//禁用自动重试，需要重试时，请自行控制</span></span><br><span class="line">        HttpRequestRetryHandler retryHandler = <span class="keyword">new</span> DefaultHttpRequestRetryHandler(<span class="number">0</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        PoolingHttpClientConnectionManager cm = <span class="keyword">new</span> PoolingHttpClientConnectionManager();</span><br><span class="line">        cm.setMaxTotal(maxTotalConnection);</span><br><span class="line">        cm.setDefaultMaxPerRoute(maxConnectionPerRoute);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建真正处理http请求的httpClient实例</span></span><br><span class="line">        CloseableHttpClient httpClient = HttpClients.custom()</span><br><span class="line">                .setDefaultHeaders(headers)</span><br><span class="line">                .setRetryHandler(retryHandler)</span><br><span class="line">                .setConnectionManager(cm)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        HttpComponentsClientHttpRequestFactory factory = <span class="keyword">new</span> HttpComponentsClientHttpRequestFactory(</span><br><span class="line">                httpClient);</span><br><span class="line">        factory.setConnectTimeout(connectionTimeout);</span><br><span class="line">        factory.setReadTimeout(readTimeout);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> RestTemplate <span class="title">createRestTemplate</span><span class="params">(ClientHttpRequestFactory factory)</span> </span>&#123;</span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate(factory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//我们采用RestTemplate内部的MessageConverter</span></span><br><span class="line">        <span class="comment">//重新设置StringHttpMessageConverter字符集，解决中文乱码问题</span></span><br><span class="line">        modifyDefaultCharset(restTemplate);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置错误处理器</span></span><br><span class="line">        restTemplate.setErrorHandler(<span class="keyword">new</span> DefaultResponseErrorHandler());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> restTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">modifyDefaultCharset</span><span class="params">(RestTemplate restTemplate)</span> </span>&#123;</span><br><span class="line">        List&lt;HttpMessageConverter&lt;?&gt;&gt; converterList = restTemplate.getMessageConverters();</span><br><span class="line">        HttpMessageConverter&lt;?&gt; converterTarget = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; item : converterList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (StringHttpMessageConverter<span class="class">.<span class="keyword">class</span> </span>== item.getClass()) &#123;</span><br><span class="line">                converterTarget = item;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != converterTarget) &#123;</span><br><span class="line">            converterList.remove(converterTarget);</span><br><span class="line">        &#125;</span><br><span class="line">        Charset defaultCharset = Charset.forName(charset);</span><br><span class="line">        converterList.add(<span class="number">1</span>, <span class="keyword">new</span> StringHttpMessageConverter(defaultCharset));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>做完上述配置，就生成了可用的RestTemplate实例</p>
<p>采用上述配置，可以做到开箱即用；自己配，可能会踩些坑，比如：<a href="http://doc.dz11.com/ddse/preview/share/9c0f4c855b09e2b1cf33?sid=187" target="_blank" rel="noopener">spring boot 配置技巧</a></p>
<h2 id="3-rest-template基本用法"><a href="#3-rest-template基本用法" class="headerlink" title="3. rest template基本用法"></a>3. rest template基本用法</h2><h3 id="3-1-get演示"><a href="#3-1-get演示" class="headerlink" title="3.1. get演示"></a>3.1. get演示</h3><ul>
<li>演示代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.douyu.wsd.framework.common.lang.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.AsyncRestTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AsyncRestTemplate asyncRestTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//最简单的get操作</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/get"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testGet</span><span class="params">(String keyword)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String kw = StringUtils.defaultString(URLEncoder.encode(keyword, <span class="string">"UTF-8"</span>));</span><br><span class="line">        String html = restTemplate.getForObject(<span class="string">"https://www.douyu.com/search/?kw="</span> + kw, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> html;<span class="comment">//返回的是斗鱼主站的html</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//需要自定义header头的get操作</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/get2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testGet2</span><span class="params">(String keyword)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">        headers.set(<span class="string">"MyHeaderKey"</span>, <span class="string">"MyHeaderValue"</span>);</span><br><span class="line">        HttpEntity entity = <span class="keyword">new</span> HttpEntity(headers);</span><br><span class="line"></span><br><span class="line">        String kw = StringUtils.defaultString(URLEncoder.encode(keyword, <span class="string">"UTF-8"</span>));</span><br><span class="line">        ResponseEntity&lt;String&gt; response = restTemplate.exchange(<span class="string">"https://www.douyu.com/search/?kw="</span> + kw, HttpMethod.GET, entity, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> response.getBody();<span class="comment">//返回的是斗鱼主站的html</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-post表单演示"><a href="#3-2-post表单演示" class="headerlink" title="3.2. post表单演示"></a>3.2. post表单演示</h3><ul>
<li>演示代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.douyu.wsd.framework.common.lang.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.common.collect.ImmutableMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.LinkedMultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.MultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/postForm"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testPostForm</span><span class="params">(String posid)</span> <span class="keyword">throws</span> Exception </span>&#123;<span class="comment">//测试用例：posid=804009</span></span><br><span class="line">        String url = <span class="string">"http://www.douyu.com/lapi/sign/app/getinfo?aid=android1&amp;client_sys=android&amp;mdid=phone&amp;time=1524495658&amp;token=&amp;auth=789c4f732d6aa4d0a5c8fb33765af8cf"</span>;</span><br><span class="line">        MultiValueMap&lt;String, String&gt; form = <span class="keyword">new</span> LinkedMultiValueMap&lt;String, String&gt;();</span><br><span class="line">        form.add(<span class="string">"app"</span>, <span class="string">"&#123;\"aname\":\"斗鱼直播\",\"pname\":\"air.tv.douyu.android\"&#125;"</span>);</span><br><span class="line">        form.add(<span class="string">"mdid"</span>, <span class="string">"phone"</span>);</span><br><span class="line">        form.add(<span class="string">"cate1"</span>, <span class="string">"0"</span>);</span><br><span class="line">        form.add(<span class="string">"client_sys"</span>, <span class="string">"ios"</span>);</span><br><span class="line">        form.add(<span class="string">"cate2"</span>, <span class="string">"0"</span>);</span><br><span class="line">        form.add(<span class="string">"auth"</span>, <span class="string">"789c4f732d6aa4d0a5c8fb33765af8cf"</span>);</span><br><span class="line">        form.add(<span class="string">"roomid"</span>, <span class="string">"0"</span>);</span><br><span class="line">        form.add(<span class="string">"posid"</span>, posid);</span><br><span class="line">        form.add(<span class="string">"imei"</span>, <span class="string">"863254010282712"</span>);</span><br><span class="line"></span><br><span class="line">        HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);</span><br><span class="line">        <span class="comment">//headers.add("xx", "yy");//可以加入自定义的header头</span></span><br><span class="line">        HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; formEntity = <span class="keyword">new</span> HttpEntity&lt;&gt;(form, headers);</span><br><span class="line">        String json = restTemplate.postForObject(url, formEntity, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> json;<span class="comment">//返回的是广告api的json</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-post请求体演示"><a href="#3-3-post请求体演示" class="headerlink" title="3.3. post请求体演示"></a>3.3. post请求体演示</h3><ul>
<li>演示代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.douyu.wsd.framework.common.lang.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/postBody"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testPostBody</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String url = <span class="string">"https://venus.dz11.com/venus/release/pc/checkUpdate"</span>;</span><br><span class="line">        String jsonBody = <span class="string">"&#123;\n"</span></span><br><span class="line">                + <span class="string">"    \"channelCode\": \"official\",\n"</span></span><br><span class="line">                + <span class="string">"    \"appCode\": \"Douyu_Live_PC_Client\",\n"</span></span><br><span class="line">                + <span class="string">"    \"versionCode\": \"201804121\",\n"</span></span><br><span class="line">                + <span class="string">"    \"versionName\": \"V5.1.9\",\n"</span></span><br><span class="line">                + <span class="string">"    \"deviceUid\": \"02-15-03-59-5C-E2\",\n"</span></span><br><span class="line">                + <span class="string">"    \"deviceResolution\": \"1920*1080\",\n"</span></span><br><span class="line">                + <span class="string">"    \"token\": \"token\",\n"</span></span><br><span class="line">                + <span class="string">"    \"webView\": \"\",\n"</span></span><br><span class="line">                + <span class="string">"    \"osInfo\": \"10.0\",\n"</span></span><br><span class="line">                + <span class="string">"    \"osType\": \"64\",\n"</span></span><br><span class="line">                + <span class="string">"    \"cpuInfo\":\n"</span></span><br><span class="line">                + <span class="string">"    &#123;\n"</span></span><br><span class="line">                + <span class="string">"        \"OemId\": \"0\",\n"</span></span><br><span class="line">                + <span class="string">"        \"ProcessorArchitecture\": \"0\",\n"</span></span><br><span class="line">                + <span class="string">"        \"PageSize\": \"4096\",\n"</span></span><br><span class="line">                + <span class="string">"        \"MinimumApplicationAddress\": \"00010000\",\n"</span></span><br><span class="line">                + <span class="string">"        \"MaximumApplicationAddress\": \"7FFEFFFF\",\n"</span></span><br><span class="line">                + <span class="string">"        \"ActiveProcessorMask\": \"15\",\n"</span></span><br><span class="line">                + <span class="string">"        \"NumberOfProcessors\": \"4\",\n"</span></span><br><span class="line">                + <span class="string">"        \"ProcessorType\": \"586\",\n"</span></span><br><span class="line">                + <span class="string">"        \"AllocationGranularity\": \"65536\",\n"</span></span><br><span class="line">                + <span class="string">"        \"ProcessorLevel\": \"6\",\n"</span></span><br><span class="line">                + <span class="string">"        \"ProcessorRevision\": \"40457\"\n"</span></span><br><span class="line">                + <span class="string">"    &#125;,\n"</span></span><br><span class="line">                + <span class="string">"    \"diskInfo\": \"931.507GB\",\n"</span></span><br><span class="line">                + <span class="string">"    \"memoryInfo\": \"15.8906GB\",\n"</span></span><br><span class="line">                + <span class="string">"    \"driveInfo\": \"Intel(R) HD Graphics 630:23.20.16.4973;\",\n"</span></span><br><span class="line">                + <span class="string">"    \"startTime\": \"-501420357\"\n"</span></span><br><span class="line">                + <span class="string">"&#125;\n"</span>;</span><br><span class="line"></span><br><span class="line">        HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        <span class="comment">//headers.add("xx", "yy");//可以加入自定义的header头</span></span><br><span class="line">        HttpEntity&lt;String&gt; bodyEntity = <span class="keyword">new</span> HttpEntity&lt;&gt;(jsonBody, headers);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//1.直接拿原始json串</span></span><br><span class="line">        String json = restTemplate.postForObject(url, bodyEntity, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//2.将原始的json传转成java对象，rest template可以自动完成</span></span><br><span class="line">        ResultVo resultVo = restTemplate.postForObject(url, bodyEntity, ResultVo<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (resultVo != <span class="keyword">null</span> &amp;&amp; resultVo.success()) &#123;</span><br><span class="line">            Object res = resultVo.getData();<span class="comment">//data节点的实际类型是java.util.LinkedHashMap</span></span><br><span class="line">            logger.info(<span class="string">"处理成功，返回数据: &#123;&#125;"</span>, resultVo.getData());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">"处理失败，响应结果: &#123;&#125;"</span>, resultVo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> json;<span class="comment">//返回的是分包api的json</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-4-post文件上传"><a href="#3-4-post文件上传" class="headerlink" title="3.4. post文件上传"></a>3.4. post文件上传</h3><blockquote>
<p>场景说明：只适合小文件（20MB以内）上传</p>
</blockquote>
<ul>
<li>演示代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.douyu.wsd.framework.common.codec.CodecUtils;</span><br><span class="line"><span class="keyword">import</span> com.douyu.wsd.framework.common.lang.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.ParameterizedTypeReference;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.FileSystemResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.LinkedMultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.MultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/postFile"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testPostBody</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String filePath = <span class="string">"D:/config.png"</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//通过磁盘文件上传，如果产生了临时文件，一定要记得删除，否则，临时文件越积越多，磁盘会爆</span></span><br><span class="line">        FileSystemResource resource = <span class="keyword">new</span> FileSystemResource(<span class="keyword">new</span> File(filePath));</span><br><span class="line">	</span><br><span class="line">        String url = <span class="string">"http://dev.resuploader.dz11.com/Resource/Dss/put"</span>;</span><br><span class="line">        String appId = <span class="string">"***"</span>;<span class="comment">//测试的时候换成自己的配置</span></span><br><span class="line">        String secureKey = <span class="string">"***"</span>;</span><br><span class="line">        String time = String.valueOf(System.currentTimeMillis());</span><br><span class="line">        String pubStr = <span class="string">"1"</span>;</span><br><span class="line">        String tempStr = String.format(<span class="string">"app_id=%s&amp;is_public=%s&amp;time=%s&amp;vframe=0%s"</span>, appId, pubStr, time, secureKey);</span><br><span class="line">        MultiValueMap&lt;String, Object&gt; form = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        form.add(<span class="string">"is_public"</span>, pubStr);</span><br><span class="line">        form.add(<span class="string">"vframe"</span>, <span class="string">"0"</span>);</span><br><span class="line">        form.add(<span class="string">"file"</span>, resource);</span><br><span class="line">        form.add(<span class="string">"app_id"</span>, appId);</span><br><span class="line">        form.add(<span class="string">"time"</span>, time);</span><br><span class="line">        form.add(<span class="string">"sign"</span>, CodecUtils.md5(tempStr));</span><br><span class="line"></span><br><span class="line">        HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">        headers.setContentType(MediaType.MULTIPART_FORM_DATA);</span><br><span class="line">        <span class="comment">//headers.add("xx", "yy");//可以加入自定义的header头</span></span><br><span class="line">        HttpEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; formEntity = <span class="keyword">new</span> HttpEntity&lt;&gt;(form, headers);</span><br><span class="line">        String json = restTemplate.postForObject(url, formEntity, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-5-文件下载"><a href="#3-5-文件下载" class="headerlink" title="3.5. 文件下载"></a>3.5. 文件下载</h3><blockquote>
<p>场景说明：只适合小文件（10MB以内）下载</p>
</blockquote>
<ul>
<li>演示代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.douyu.wsd.framework.common.lang.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.InputStreamResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/downloadFile"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity <span class="title">testDownloadFile</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String url = <span class="string">"http://editor.baidu.com/editor/download/BaiduEditor(Online)_5-9-16.exe"</span>;</span><br><span class="line">        HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">        headers.setAccept(Collections.singletonList(MediaType.APPLICATION_OCTET_STREAM));</span><br><span class="line">        HttpEntity&lt;String&gt; entity = <span class="keyword">new</span> HttpEntity&lt;&gt;(headers);</span><br><span class="line">        ResponseEntity&lt;<span class="keyword">byte</span>[]&gt; response = restTemplate.exchange(url, HttpMethod.GET, entity, <span class="keyword">byte</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = response.getBody();</span><br><span class="line">        <span class="keyword">long</span> contentLength = bytes != <span class="keyword">null</span> ? bytes.length : <span class="number">0</span>;</span><br><span class="line">        headers.setContentLength((<span class="keyword">int</span>) contentLength);</span><br><span class="line">        headers.setContentDispositionFormData(<span class="string">"baidu.exe"</span>, URLEncoder.encode(<span class="string">"百度安装包.exe"</span>, <span class="string">"UTF-8"</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(response.getBody(), headers, HttpStatus.OK);</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-6-更多API"><a href="#3-6-更多API" class="headerlink" title="3.6. 更多API"></a>3.6. 更多API</h3><h4 id="3-6-1-RestTemplate-API-与http动词的对象关系："><a href="#3-6-1-RestTemplate-API-与http动词的对象关系：" class="headerlink" title="3.6.1.  RestTemplate API 与http动词的对象关系："></a>3.6.1.  RestTemplate API 与http动词的对象关系：</h4><table>
<thead>
<tr>
<th>HTTP动词</th>
<th align="center">对应的RestTemplate API</th>
</tr>
</thead>
<tbody><tr>
<td>DELETE</td>
<td align="center">delete(String, String…)</td>
</tr>
<tr>
<td>GET</td>
<td align="center">getForObject(String, Class, String…)</td>
</tr>
<tr>
<td>HEAD</td>
<td align="center">headForHeaders(String, String…)</td>
</tr>
<tr>
<td>OPTIONS</td>
<td align="center">optionsForAllow(String, String…)</td>
</tr>
<tr>
<td>POST</td>
<td align="center">postForLocation(String, Object, String…)</td>
</tr>
<tr>
<td>PUT</td>
<td align="center">put(String, Object, String…)</td>
</tr>
</tbody></table>
<h4 id="3-6-2-post-get-ForEntity-API-和-post-get-ForObject-的区别"><a href="#3-6-2-post-get-ForEntity-API-和-post-get-ForObject-的区别" class="headerlink" title="3.6.2.  (post|get)ForEntity API 和 (post|get)ForObject 的区别"></a>3.6.2.  (post|get)ForEntity API 和 (post|get)ForObject 的区别</h4><pre><code>ForEntity API拿到的是ResponseEntity，通过ResponseEntity可以拿到状态码，response header等信息

ForObject API拿到的是java对象，用在不关心response状态码和header的场合中</code></pre><h4 id="3-6-3-getXXX、postXXX-和-exchange-方法的区别"><a href="#3-6-3-getXXX、postXXX-和-exchange-方法的区别" class="headerlink" title="3.6.3. getXXX、postXXX 和 exchange 方法的区别"></a>3.6.3. getXXX、postXXX 和 exchange 方法的区别</h4><pre><code>getXXX、postXXX 用于比较简单的调用

exchange 用于比较复杂的调用</code></pre><h2 id="4-rest-template高阶用法"><a href="#4-rest-template高阶用法" class="headerlink" title="4. rest template高阶用法"></a>4. rest template高阶用法</h2><h3 id="4-1-带泛型的响应解码"><a href="#4-1-带泛型的响应解码" class="headerlink" title="4.1. 带泛型的响应解码"></a>4.1. 带泛型的响应解码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.douyu.wsd.framework.common.lang.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.ParameterizedTypeReference;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(TestController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/postBody"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testPostBody</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;<span class="comment">//测试用例：posid=804009</span></span><br><span class="line">        String url = <span class="string">"https://venus.dz11.com/venus/release/pc/checkUpdate"</span>;</span><br><span class="line">        String jsonBody = <span class="string">"&#123;\n"</span></span><br><span class="line">                + <span class="string">"    \"channelCode\": \"official\",\n"</span></span><br><span class="line">                + <span class="string">"    \"appCode\": \"Douyu_Live_PC_Client\",\n"</span></span><br><span class="line">                + <span class="string">"    \"versionCode\": \"201804121\",\n"</span></span><br><span class="line">                + <span class="string">"    \"versionName\": \"V5.1.9\",\n"</span></span><br><span class="line">                + <span class="string">"    \"deviceUid\": \"02-15-03-59-5C-E2\",\n"</span></span><br><span class="line">                + <span class="string">"    \"deviceResolution\": \"1920*1080\",\n"</span></span><br><span class="line">                + <span class="string">"    \"token\": \"token\",\n"</span></span><br><span class="line">                + <span class="string">"    \"webView\": \"\",\n"</span></span><br><span class="line">                + <span class="string">"    \"osInfo\": \"10.0\",\n"</span></span><br><span class="line">                + <span class="string">"    \"osType\": \"64\",\n"</span></span><br><span class="line">                + <span class="string">"    \"cpuInfo\":\n"</span></span><br><span class="line">                + <span class="string">"    &#123;\n"</span></span><br><span class="line">                + <span class="string">"        \"OemId\": \"0\",\n"</span></span><br><span class="line">                + <span class="string">"        \"ProcessorArchitecture\": \"0\",\n"</span></span><br><span class="line">                + <span class="string">"        \"PageSize\": \"4096\",\n"</span></span><br><span class="line">                + <span class="string">"        \"MinimumApplicationAddress\": \"00010000\",\n"</span></span><br><span class="line">                + <span class="string">"        \"MaximumApplicationAddress\": \"7FFEFFFF\",\n"</span></span><br><span class="line">                + <span class="string">"        \"ActiveProcessorMask\": \"15\",\n"</span></span><br><span class="line">                + <span class="string">"        \"NumberOfProcessors\": \"4\",\n"</span></span><br><span class="line">                + <span class="string">"        \"ProcessorType\": \"586\",\n"</span></span><br><span class="line">                + <span class="string">"        \"AllocationGranularity\": \"65536\",\n"</span></span><br><span class="line">                + <span class="string">"        \"ProcessorLevel\": \"6\",\n"</span></span><br><span class="line">                + <span class="string">"        \"ProcessorRevision\": \"40457\"\n"</span></span><br><span class="line">                + <span class="string">"    &#125;,\n"</span></span><br><span class="line">                + <span class="string">"    \"diskInfo\": \"931.507GB\",\n"</span></span><br><span class="line">                + <span class="string">"    \"memoryInfo\": \"15.8906GB\",\n"</span></span><br><span class="line">                + <span class="string">"    \"driveInfo\": \"Intel(R) HD Graphics 630:23.20.16.4973;\",\n"</span></span><br><span class="line">                + <span class="string">"    \"startTime\": \"-501420357\"\n"</span></span><br><span class="line">                + <span class="string">"&#125;\n"</span>;</span><br><span class="line"></span><br><span class="line">        HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        HttpEntity&lt;String&gt; bodyEntity = <span class="keyword">new</span> HttpEntity&lt;&gt;(jsonBody, headers);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//1. 直接拿原始的json串</span></span><br><span class="line">        String json = restTemplate.postForObject(url, bodyEntity, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 将原始json传转java对象，跟上文不同的是，这个java对象里面有泛型（ResultVo&lt;PcUpdateRes&gt;）</span></span><br><span class="line">        <span class="comment">//大家实际使用的时候，把ResultVo&lt;PcUpdateRes&gt;换成自己的类，比如：List&lt;MemberInfo&gt;</span></span><br><span class="line">        ResponseEntity&lt;ResultVo&lt;PcUpdateRes&gt;&gt; response = restTemplate</span><br><span class="line">                .exchange(url, HttpMethod.POST, bodyEntity, <span class="keyword">new</span> ParameterizedTypeReference&lt;ResultVo&lt;PcUpdateRes&gt;&gt;() &#123;&#125;);</span><br><span class="line">        <span class="keyword">if</span> (response.getStatusCode().is2xxSuccessful() &amp;&amp; response.getBody() != <span class="keyword">null</span> &amp;&amp; response.getBody().success()) &#123;</span><br><span class="line">            ResultVo&lt;PcUpdateRes data = &gt; resultVo = response.getBody();</span><br><span class="line">            PcUpdateRes data = resultVo.getData();</span><br><span class="line">            logger.info(<span class="string">"处理成功，返回数据: &#123;&#125;"</span>, data);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">"处理失败，响应结果: &#123;&#125;"</span>, response);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-上传文件流"><a href="#4-2-上传文件流" class="headerlink" title="4.2. 上传文件流"></a>4.2. 上传文件流</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.douyu.wsd.framework.common.codec.CodecUtils;</span><br><span class="line"><span class="keyword">import</span> com.douyu.wsd.framework.common.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> com.douyu.wsd.framework.common.lang.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.ParameterizedTypeReference;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.InputStreamResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.LinkedMultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.MultiValueMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/postFile"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testPostBody</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String filePath = <span class="string">"D:/config.png"</span>;</span><br><span class="line">        MultipartFileResource resource = <span class="keyword">new</span> MultipartFileResource(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(filePath)), <span class="string">"config.png"</span>);</span><br><span class="line">        String url = <span class="string">"http://dev.resuploader.dz11.com/Resource/Dss/put"</span>;</span><br><span class="line">        String appId = <span class="string">"***"</span>;<span class="comment">//测试的时候换成自己的配置</span></span><br><span class="line">        String secureKey = <span class="string">"***"</span>;</span><br><span class="line">        String time = String.valueOf(System.currentTimeMillis());</span><br><span class="line">        String pubStr = <span class="string">"1"</span>;</span><br><span class="line">        String tempStr = String.format(<span class="string">"app_id=%s&amp;is_public=%s&amp;time=%s&amp;vframe=0%s"</span>, appId, pubStr, time, secureKey);</span><br><span class="line">        MultiValueMap&lt;String, Object&gt; form = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">        form.add(<span class="string">"is_public"</span>, pubStr);</span><br><span class="line">        form.add(<span class="string">"vframe"</span>, <span class="string">"0"</span>);</span><br><span class="line">        form.add(<span class="string">"file"</span>, resource);</span><br><span class="line">        form.add(<span class="string">"app_id"</span>, appId);</span><br><span class="line">        form.add(<span class="string">"time"</span>, time);</span><br><span class="line">        form.add(<span class="string">"sign"</span>, CodecUtils.md5(tempStr));</span><br><span class="line"></span><br><span class="line">        HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">        headers.setContentType(MediaType.MULTIPART_FORM_DATA);</span><br><span class="line">        <span class="comment">//headers.add("xx", "yy");//可以加入自定义的header头</span></span><br><span class="line">        HttpEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; formEntity = <span class="keyword">new</span> HttpEntity&lt;&gt;(form, headers);</span><br><span class="line">        String json = restTemplate.postForObject(url, formEntity, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MultipartFileResource</span> <span class="keyword">extends</span> <span class="title">InputStreamResource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String filename;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MultipartFileResource</span><span class="params">(InputStream inputStream, String filename)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(inputStream);</span><br><span class="line">            <span class="keyword">this</span>.filename = filename;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getFilename</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.filename;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">contentLength</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>; <span class="comment">// we do not want to generally read the whole stream into memory ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-异步操作"><a href="#4-3-异步操作" class="headerlink" title="4.3 异步操作"></a>4.3 异步操作</h3><ul>
<li>AsyncRestTemplate 可支持异步，与同步API基本一致，返回的是future:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.douyu.wsd.framework.common.lang.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.concurrent.ListenableFuture;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.AsyncRestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AsyncRestTemplate asyncRestTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/douyu"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">douyu</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; future = asyncRestTemplate</span><br><span class="line">                .getForEntity(<span class="string">"http://www.douyu.com"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> future.get(<span class="number">2</span> * <span class="number">1000</span>, TimeUnit.SECONDS).getBody();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-不同的超时时间"><a href="#4-4-不同的超时时间" class="headerlink" title="4.4. 不同的超时时间"></a>4.4. 不同的超时时间</h3><p>假如我碰到这种场景：</p>
<pre><code>ServiceA | 10s

ServiceB | 25s</code></pre><p>有3个套路可解决：</p>
<ul>
<li>套路一，创建多个实例，每个实例有自己的超时时间，比如</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 超时时间短的实例</span></span><br><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"clientHttpRequestFactoryA"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ClientHttpRequestFactory <span class="title">clientHttpRequestFactoryA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createClientHttpRequestFactory(<span class="number">2</span>*<span class="number">1000</span>, <span class="number">10</span>*<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"restTemplateA"</span>)</span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(RestTemplate<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">RestTemplate</span> <span class="title">restTemplateA</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createRestTemplate(clientHttpRequestFactoryA());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 超时时间长的实例</span></span><br><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"clientHttpRequestFactoryB"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ClientHttpRequestFactory <span class="title">clientHttpRequestFactoryB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createClientHttpRequestFactory(<span class="number">5</span>*<span class="number">1000</span>, <span class="number">25</span>*<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"restTemplateB"</span>)</span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(RestTemplate<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">RestTemplate</span> <span class="title">restTemplateB</span>() </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createRestTemplate(clientHttpRequestFactoryB());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>套路二，AsyncRestTemplate</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ListenableFuture&lt;ResponseEntity&lt;String&gt;&gt; future = asyncRestTemplate</span><br><span class="line">                .getForEntity(<span class="string">"http://www.douyu.com"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="keyword">return</span> future.get(<span class="number">2</span> * <span class="number">1000</span>, TimeUnit.SECONDS).getBody();</span><br></pre></td></tr></table></figure>

<ul>
<li>套路三，上<a href="https://spring.io/guides/gs/circuit-breaker/" target="_blank" rel="noopener"> Circuit Breaker</a></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MyApp <span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BookService</span><span class="params">(RestTemplate rest)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.restTemplate = rest;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand</span>(</span><br><span class="line">        fallbackMethod = <span class="string">"fooMethodFallback"</span>,</span><br><span class="line">        commandProperties = &#123; </span><br><span class="line">            <span class="meta">@HystrixProperty</span>(</span><br><span class="line">                 name = <span class="string">"execution.isolation.thread.timeoutInMilliseconds"</span>, </span><br><span class="line">                 value=<span class="string">"5000"</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">fooMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Your logic here.</span></span><br><span class="line">        restTemplate.exchange(...); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">fooMethodFallback</span><span class="params">(Throwable t)</span> </span>&#123;</span><br><span class="line">        log.error(<span class="string">"Fallback happened"</span>, t);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Sensible Default Here!"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-如何设置连接池"><a href="#4-5-如何设置连接池" class="headerlink" title="4.5. 如何设置连接池"></a>4.5. 如何设置连接池</h3><ul>
<li>连接池需要服务端支持长连接，并非所有服务端都支持，因此单独开了篇文章：<a href="http://doc.dz11.com/ddse/preview/space/14816?sid=29&pid=12940" target="_blank" rel="noopener">RestTemplate如何配置长连接</a></li>
</ul>
<h3 id="4-6-全局统一的异常处理"><a href="#4-6-全局统一的异常处理" class="headerlink" title="4.6. 全局统一的异常处理"></a>4.6. 全局统一的异常处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实现异常处理接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomErrorHandler</span> <span class="keyword">extends</span> <span class="title">DefaultResponseErrorHandler</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleError</span><span class="params">(ClientHttpResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//将自定义的异常处理器加进去</span></span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestClientConfig</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Bean</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();  </span><br><span class="line">        restTemplate.setErrorHandler(<span class="keyword">new</span> CustomErrorHandler());  </span><br><span class="line">        <span class="keyword">return</span> restTemplate;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-小技巧"><a href="#5-小技巧" class="headerlink" title="5. 小技巧"></a>5. 小技巧</h2><h3 id="5-1-参数模板"><a href="#5-1-参数模板" class="headerlink" title="5.1. 参数模板"></a>5.1. 参数模板</h3><ul>
<li>数组传参</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String result = restTemplate.getForObject(<span class="string">"http://example.com/hotels/&#123;hotel&#125;/bookings/&#123;booking&#125;"</span>, </span><br><span class="line">    String.class, "42", "21");</span><br><span class="line"><span class="comment">//实际效果等同于：GET http://example.com/hotels/42/bookings/21</span></span><br></pre></td></tr></table></figure>

<ul>
<li>map传参</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; vars = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">vars.put(<span class="string">"hotel"</span>, <span class="string">"42"</span>);</span><br><span class="line">vars.put(<span class="string">"booking"</span>, <span class="string">"21"</span>);</span><br><span class="line">String result = restTemplate.getForObject(<span class="string">"http://example.com/hotels/&#123;hotel&#125;/bookings/&#123;booking&#125;"</span>, </span><br><span class="line">    String<span class="class">.<span class="keyword">class</span>, <span class="title">vars</span>)</span>;</span><br><span class="line"><span class="comment">//实际效果等同于：GET http://example.com/hotels/42/rooms/42</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-文件上传注意点"><a href="#5-2-文件上传注意点" class="headerlink" title="5.2. 文件上传注意点"></a>5.2. 文件上传注意点</h3><ul>
<li>如果使用了本地临时文件，一定要在finally代码块中删除，否则可能会撑爆磁盘</li>
</ul>
<h2 id="6-FAQ"><a href="#6-FAQ" class="headerlink" title="6. FAQ"></a>6. FAQ</h2><h3 id="6-1-获取状态码"><a href="#6-1-获取状态码" class="headerlink" title="6.1. 获取状态码"></a>6.1. 获取状态码</h3><p>使用xxForEntity类方法调用接口，将返回ResponseEntity对象，通过它能取到状态码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//判断接口返回是否为200</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Boolean <span class="title">ping</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String url = <span class="string">"xxx"</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        ResponseEntity&lt;String&gt; responseEntity = restTemplate.getForEntity(url, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        HttpStatus status = responseEntity.getStatusCode();<span class="comment">//获取返回状态</span></span><br><span class="line">        <span class="keyword">return</span> status.is2xxSuccessful();<span class="comment">//判断状态码是否为2开头的</span></span><br><span class="line">    &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">        log.error(<span class="string">"处理失败: &#123;&#125;"</span>, url, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">//502 ,500是不能正常返回结果的，需要catch住，返回一个false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-我需要手工释放连接吗？"><a href="#6-2-我需要手工释放连接吗？" class="headerlink" title="6.2. 我需要手工释放连接吗？"></a>6.2. 我需要手工释放连接吗？</h3><ul>
<li>不需要，rest template会帮我们释放，具体请看：<a href="https://stackoverflow.com/questions/40161117/spring-resttemplate-need-to-release-connection" target="_blank" rel="noopener">spring-resttemplate-need-to-release-connection ?</a></li>
</ul>
<h3 id="6-2-如何调试rest-template"><a href="#6-2-如何调试rest-template" class="headerlink" title="6.2. 如何调试rest template"></a>6.2. 如何调试rest template</h3><p>可以在logback里单独配一个debug级别的logger，把org.apache.http下面的日志定向到控制台：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"org.apache.http"</span> <span class="attr">level</span>=<span class="string">"DEBUG"</span> <span class="attr">additivity</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br></pre></td></tr></table></figure>
    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：转载请注明出处，如有侵权请联系 © <a href="mailto:abner510@126.com" target="_blank">abner-xu</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/2018/08/24/Mysql/mysql总结/" class="pre-post btn btn-default" title='mysql总结'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">mysql总结</span>
        </a>
    
    
        <a href="/2018/02/26/git命令大全/" class="next-post btn btn-default" title='git命令大全'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">git命令大全</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
   <p>评论系统未开启，无法评论！</p>

    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-xs-6 col-sm-3">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-规范背景"><span class="toc-text">1. 规范背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-http-client选择"><span class="toc-text">1.1. http client选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-rest-template-运行环境"><span class="toc-text">1.2. rest template 运行环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-配置-rest-template"><span class="toc-text">2. 配置 rest template</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-引入jar包"><span class="toc-text">2.1. 引入jar包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-编写-yml-文件配置（可选）"><span class="toc-text">2.2. 编写 yml 文件配置（可选）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-编写java配置（必备，不可省略）"><span class="toc-text">2.3. 编写java配置（必备，不可省略）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-rest-template基本用法"><span class="toc-text">3. rest template基本用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-get演示"><span class="toc-text">3.1. get演示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-post表单演示"><span class="toc-text">3.2. post表单演示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-post请求体演示"><span class="toc-text">3.3. post请求体演示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-post文件上传"><span class="toc-text">3.4. post文件上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-文件下载"><span class="toc-text">3.5. 文件下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-更多API"><span class="toc-text">3.6. 更多API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-1-RestTemplate-API-与http动词的对象关系："><span class="toc-text">3.6.1.  RestTemplate API 与http动词的对象关系：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-2-post-get-ForEntity-API-和-post-get-ForObject-的区别"><span class="toc-text">3.6.2.  (post|get)ForEntity API 和 (post|get)ForObject 的区别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-6-3-getXXX、postXXX-和-exchange-方法的区别"><span class="toc-text">3.6.3. getXXX、postXXX 和 exchange 方法的区别</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-rest-template高阶用法"><span class="toc-text">4. rest template高阶用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-带泛型的响应解码"><span class="toc-text">4.1. 带泛型的响应解码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-上传文件流"><span class="toc-text">4.2. 上传文件流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-异步操作"><span class="toc-text">4.3 异步操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-不同的超时时间"><span class="toc-text">4.4. 不同的超时时间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-如何设置连接池"><span class="toc-text">4.5. 如何设置连接池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-全局统一的异常处理"><span class="toc-text">4.6. 全局统一的异常处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-小技巧"><span class="toc-text">5. 小技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-参数模板"><span class="toc-text">5.1. 参数模板</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-文件上传注意点"><span class="toc-text">5.2. 文件上传注意点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-FAQ"><span class="toc-text">6. FAQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-获取状态码"><span class="toc-text">6.1. 获取状态码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-我需要手工释放连接吗？"><span class="toc-text">6.2. 我需要手工释放连接吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-如何调试rest-template"><span class="toc-text">6.2. 如何调试rest template</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
        访问量:
        <strong id="busuanzi_value_site_pv">
            <i class="fa fa-spinner fa-spin"></i>
        </strong>
        &nbsp; | &nbsp;
        访客数:
        <strong id="busuanzi_value_site_uv">
            <i class="fa fa-spinner fa-spin"></i>
        </strong>
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>






    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>